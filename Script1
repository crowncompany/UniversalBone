local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer

-- constantboxnames
local HIGHLIGHT_NAME = "UniversalESP_Highlight"
local NAME_TAG_NAME = "UniversalESP_NameTag"
local BOX_NAME = "UniversalESP_Box"
local DISTANCE_TAG_NAME = "UniversalESP_Distance"

-- rgb settings
local HIGHLIGHT_COLOR = Color3.fromRGB(173, 216, 230)
local FILL_TRANSPARENCY = 0.75
local OUTLINE_COLOR = Color3.fromRGB(0, 191, 255)
local OUTLINE_TRANSPARENCY = 0

local NAME_COLOR = Color3.fromRGB(255, 255, 255)
local NAME_FONT = Enum.Font.Gotham
local HEALTH_BAR_COLOR = Color3.fromRGB(0, 255, 0)

local espEnabled = false  -- Variable to track the ESP status
local activeESP = {}  -- Store active ESP components for cleanup

-- highlight effect
local function applyHighlight(character)
    if character:FindFirstChild(HIGHLIGHT_NAME) then return end

    local highlight = Instance.new("Highlight")
    highlight.Name = HIGHLIGHT_NAME
    highlight.Adornee = character
    highlight.FillColor = HIGHLIGHT_COLOR
    highlight.FillTransparency = FILL_TRANSPARENCY
    highlight.OutlineColor = OUTLINE_COLOR
    highlight.OutlineTransparency = OUTLINE_TRANSPARENCY
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = character
end

-- add name and health bar above head
local function createNameAndHealthTag(character, player)
    if character:FindFirstChild(NAME_TAG_NAME) then return end

    local head = character:FindFirstChild("Head")
    if not head then return end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = NAME_TAG_NAME
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 100, 0, 40)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.LightInfluence = 0
    billboard.MaxDistance = math.huge

    -- Health bar background
    local healthBg = Instance.new("Frame")
    healthBg.Size = UDim2.new(1, 0, 0, 4)
    healthBg.Position = UDim2.new(0, 0, 0, 0)
    healthBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    healthBg.BorderSizePixel = 0
    healthBg.Parent = billboard

    -- Health bar fill
    local healthFill = Instance.new("Frame")
    healthFill.Name = "HealthFill"
    healthFill.Size = UDim2.new(1, 0, 1, 0)
    healthFill.BackgroundColor3 = HEALTH_BAR_COLOR
    healthFill.BorderSizePixel = 0
    healthFill.Parent = healthBg

    -- Username label
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 0, 20)
    nameLabel.Position = UDim2.new(0, 0, 0, 10)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.Name
    nameLabel.TextColor3 = NAME_COLOR
    nameLabel.TextStrokeTransparency = 0 -- Solid black border
    nameLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    nameLabel.Font = NAME_FONT
    nameLabel.TextScaled = true
    nameLabel.TextWrapped = true
    nameLabel.Parent = billboard

    billboard.Parent = character

    -- Always-on health update loop
    RunService.RenderStepped:Connect(function()
        if character and character:FindFirstChild("Humanoid") and healthFill then
            local hp = character.Humanoid.Health
            local maxHp = character.Humanoid.MaxHealth
            if maxHp > 0 then
                healthFill.Size = UDim2.new(math.clamp(hp / maxHp, 0, 1), 0, 1, 0)
            end
        end
    end)
end

local function applyHitboxBox(character)
    if character:FindFirstChild(BOX_NAME) then return end

    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local hitboxPart = Instance.new("Part")
    hitboxPart.Name = "HitboxPart"
    hitboxPart.Anchored = true
    hitboxPart.CanCollide = false
    hitboxPart.Transparency = 1
    hitboxPart.Size = Vector3.new(6, 7, 3) -- Adjusted to fit a typical avatar
    hitboxPart.CFrame = hrp.CFrame
    hitboxPart.Parent = character
end

-- distance in meters
local function createDistanceIndicator(character, player)
    if character:FindFirstChild(DISTANCE_TAG_NAME) then return end

    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = DISTANCE_TAG_NAME
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0, 100, 0, 20)
    billboard.StudsOffset = Vector3.new(0, -2.5, 0)
    billboard.AlwaysOnTop = true
    billboard.LightInfluence = 0
    billboard.MaxDistance = math.huge

    local text = Instance.new("TextLabel")
    text.Size = UDim2.new(1, 0, 1, 0)
    text.BackgroundTransparency = 1
    text.TextColor3 = Color3.fromRGB(200, 200, 255)
    text.TextStrokeTransparency = 0.5
    text.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    text.Font = NAME_FONT
    text.TextScaled = true
    text.Text = "Distance"
    text.Parent = billboard

    billboard.Parent = character

    -- Live distance updating
    RunService.RenderStepped:Connect(function()
        if character and character:FindFirstChild("HumanoidRootPart") and localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local dist = (character.HumanoidRootPart.Position - localPlayer.Character.HumanoidRootPart.Position).Magnitude
            text.Text = string.format("%.1f meters", dist)

            -- Hide ESP components if the distance is greater than 500 meters
            if dist > 500 then
                billboard.Enabled = false  -- Hide distance label
                local nameTag = character:FindFirstChild(NAME_TAG_NAME)
                if nameTag then nameTag.Enabled = false end
                local healthTag = character:FindFirstChild(NAME_TAG_NAME)
                if healthTag then healthTag.Enabled = false end
                local boxTag = character:FindFirstChild(BOX_NAME)
                if boxTag then boxTag.Enabled = false end
            else
                billboard.Enabled = true  -- Show distance label
                local nameTag = character:FindFirstChild(NAME_TAG_NAME)
                if nameTag then nameTag.Enabled = true end
                local healthTag = character:FindFirstChild(NAME_TAG_NAME)
                if healthTag then healthTag.Enabled = true end
                local boxTag = character:FindFirstChild(BOX_NAME)
                if boxTag then boxTag.Enabled = true end
            end
        end
    end)
end

-- current apply function
local function applyESPToPlayer(player)
    if player == localPlayer then return end

    local function onCharacterAdded(character)
        repeat task.wait() until character:IsDescendantOf(workspace)

        applyHighlight(character)
        createNameAndHealthTag(character, player)
        applyHitboxBox(character)
        createDistanceIndicator(character, player)
    end

    if player.Character then
        onCharacterAdded(player.Character)
    end

    player.CharacterAdded:Connect(onCharacterAdded)
end

-- Function to enable ESP for all players
local function enableESP()
    if espEnabled then return end  -- Don't enable if already enabled

    for _, player in ipairs(Players:GetPlayers()) do
        applyESPToPlayer(player)
    end

    Players.PlayerAdded:Connect(applyESPToPlayer)
    espEnabled = true
end

-- Function to disable ESP for all players
local function disableESP()
    if not espEnabled then return end  -- Don't disable if already disabled

    -- get rid of random active esp items
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local character = player.Character
            -- Remove Highlight
            local highlight = character:FindFirstChild(HIGHLIGHT_NAME)
            if highlight then highlight:Destroy() end

            -- Remove Name and Health tags
            local nameTag = character:FindFirstChild(NAME_TAG_NAME)
            if nameTag then nameTag:Destroy() end

            -- Remove Distance Indicator
            local distanceTag = character:FindFirstChild(DISTANCE_TAG_NAME)
            if distanceTag then distanceTag:Destroy() end
        end
    end

    espEnabled = false
end

-- make ui button for toggle on or off
local screenGui = Instance.new("ScreenGui", localPlayer.PlayerGui)
local button = Instance.new("TextButton", screenGui)
button.Size = UDim2.new(0, 150, 0, 50)
button.Position = UDim2.new(0, 10, 0, 10)
button.BackgroundColor3 = Color3.fromRGB(35, 35, 50)
button.Text = "Enable ESP"
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.Font = Enum.Font.Gotham
button.TextSize = 18
Instance.new("UICorner", button).CornerRadius = UDim.new(0, 8)

-- disable and enable function for esp
button.MouseButton1Click:Connect(function()
    if espEnabled then
        button.Text = "Enable ESP"
        disableESP()
    else
        button.Text = "Disable ESP"
        enableESP()
    end
end)

-- apply the esp to all the existing players
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= localPlayer then
        applyESPToPlayer(player)
    end
end

Players.PlayerAdded:Connect(applyESPToPlayer)
